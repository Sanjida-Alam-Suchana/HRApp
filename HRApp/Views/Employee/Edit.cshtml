@model HRApp.Models.Employee

@{
    ViewData["Title"] = "Edit Employee";
    var shiftsJson = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Shifts ?? new List<Shift>());
    var deptsJson = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Departments ?? new List<Department>());
    var desigsJson = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.Designations ?? new List<Designation>());
}

<div class="container">
    <h2>Edit Employee</h2>
    <div>
        <label>Select Company:</label>
        <select id="companyFilter" class="form-select d-inline w-auto" onchange="filterByCompany()">
            <option value="">All Companies</option>
            @foreach (var company in ViewBag.Companies ?? new List<dynamic>())
            {
                <option value="@company.Id" selected="@(ViewBag.SelectedCompanyId == company.Id)">
                    @company.ComName
                </option>
            }
        </select>
    </div>

    <form id="employeeEditForm" novalidate>
        <input type="hidden" asp-for="Id" />
        <div class="mb-3">
            <label asp-for="EmpCode" class="form-label"></label>
            <input asp-for="EmpCode" class="form-control" required />
            <span asp-validation-for="EmpCode" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="EmpName" class="form-label"></label>
            <input asp-for="EmpName" class="form-control" required />
            <span asp-validation-for="EmpName" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="ShiftId" class="form-label"></label>
            <select asp-for="ShiftId" class="form-select" required>
                <option value="">-- Select Shift --</option>
                @foreach (var shift in ViewBag.Shifts ?? new List<Shift>())
                {
                    <option value="@shift.Id" selected="@(Model.ShiftId == shift.Id)">@shift.ShiftName</option>
                }
            </select>
            <span asp-validation-for="ShiftId" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="DeptId" class="form-label"></label>
            <select asp-for="DeptId" class="form-select" required>
                <option value="">-- Select Department --</option>
                @foreach (var dept in ViewBag.Departments ?? new List<Department>())
                {
                    <option value="@dept.Id" selected="@(Model.DeptId == dept.Id)">@dept.DeptName</option>
                }
            </select>
            <span asp-validation-for="DeptId" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="DesigId" class="form-label"></label>
            <select asp-for="DesigId" class="form-select" required>
                <option value="">-- Select Designation --</option>
                @foreach (var desig in ViewBag.Designations ?? new List<Designation>())
                {
                    <option value="@desig.Id" selected="@(Model.DesigId == desig.Id)">@desig.DesigName</option>
                }
            </select>
            <span asp-validation-for="DesigId" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Gender" class="form-label"></label>
            <select asp-for="Gender" class="form-select" required>
                <option value="">-- Select Gender --</option>
                <option value="Male" selected="@(Model.Gender == "Male")">Male</option>
                <option value="Female" selected="@(Model.Gender == "Female")">Female</option>
                <option value="Other" selected="@(Model.Gender == "Other")">Other</option>
            </select>
            <span asp-validation-for="Gender" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Gross" class="form-label"></label>
            <input asp-for="Gross" class="form-control" type="number" step="0.01" min="0" required />
            <span asp-validation-for="Gross" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="dtJoin" class="form-label"></label>
            <input asp-for="dtJoin" class="form-control" type="date" required />
            <span asp-validation-for="dtJoin" class="text-danger"></span>
        </div>
        <button type="submit" class="btn btn-primary">Save</button>
        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
    </form>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script>
        var shifts = @Html.Raw(shiftsJson);
        var departments = @Html.Raw(deptsJson);
        var designations = @Html.Raw(desigsJson);

        $(document).ready(function () {
            $("#employeeEditForm").on("submit", function (e) {
                e.preventDefault();
                if ($(this).valid()) {
                    $.ajax({
                        url: '@Url.Action("Edit", "Employee")',
                        type: "POST",
                        data: $(this).serialize(),
                        success: function (response) {
                            if (response.success) {
                                alert(response.message);
                                window.location.href = '@Url.Action("Index", "Employee")';
                            } else {
                                alert("Error: " + (response.errors ? response.errors.join(', ') : "Unknown error"));
                            }
                        },
                        error: function (xhr, status, error) {
                            alert("Submit failed: " + error + "\nStatus: " + xhr.status);
                        }
                    });
                }
            });
        });

        function filterByCompany() {
            var selectedId = $("#companyFilter").val();
            if (selectedId) {
                $.post('@Url.Action("SetSelectedCompany", "Home")', { companyId: selectedId }, function () {
                    loadEmployees();
                });
            } else {
                loadEmployees();
            }
        }

        function loadEmployees() {
            $.get('@Url.Action("GetEmployees", "Employee")', function (data) {
                var tbody = $("#employeesTable tbody");
                tbody.empty();
                var selectedId = $("#companyFilter").val() || "@ViewBag.SelectedCompanyId";
                var filteredData = selectedId ? data.filter(e => e.comId == selectedId) : data;

                $.each(filteredData, function (index, employee) {
                    var shiftName = shifts.find(s => s.Id === employee.shiftId)?.ShiftName || "";
                    var deptName = departments.find(d => d.Id === employee.deptId)?.DeptName || "";
                    var desigName = designations.find(d => d.Id === employee.desigId)?.DesigName || "";

                    tbody.append(`
                        <tr>
                            <td>${employee.empCode}</td>
                            <td>${employee.empName}</td>
                            <td>${shiftName}</td>
                            <td>${deptName}</td>
                            <td>${desigName}</td>
                            <td>${employee.gender}</td>
                            <td>${employee.gross}</td>
                            <td>${employee.dtJoin}</td>
                            <td>
                                <a href="@Url.Action("Edit", "Employee")/${employee.id}" class="btn btn-sm btn-warning">Edit</a>
                                <button class="btn btn-sm btn-danger delete-btn" data-id="${employee.id}">Delete</button>
                            </td>
                        </tr>
                    `);
                });
            }).fail(function () {
                alert("Error loading employees");
            });
        }
    </script>
}

@* @model HRApp.Models.Employee

@{
    ViewData["Title"] = "Edit Employee";
}

<form id="employeeEditForm" novalidate>
    <input type="hidden" asp-for="Id" />
    <div class="mb-3">
        <label class="form-label">Employee Code</label>
        <input asp-for="EmpCode" class="form-control" required />
        <span asp-validation-for="EmpCode" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Employee Name</label>
        <input asp-for="EmpName" class="form-control" required />
        <span asp-validation-for="EmpName" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Shift</label>
        <select asp-for="ShiftId" class="form-control" asp-items="@(new SelectList(ViewBag.Shifts, "Id", "ShiftName"))" required>
            <option value="">Select Shift</option>
        </select>
        <span asp-validation-for="ShiftId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Department</label>
        <select asp-for="DeptId" class="form-control" asp-items="@(new SelectList(ViewBag.Departments, "Id", "DeptName"))" required>
            <option value="">Select Department</option>
        </select>
        <span asp-validation-for="DeptId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Designation</label>
        <select asp-for="DesigId" class="form-control" asp-items="@(new SelectList(ViewBag.Designations, "Id", "DesigName"))" required>
            <option value="">Select Designation</option>
        </select>
        <span asp-validation-for="DesigId" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Gender</label>
        <input asp-for="Gender" class="form-control" required />
        <span asp-validation-for="Gender" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Gross</label>
        <input asp-for="Gross" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="Gross" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Basic</label>
        <input asp-for="Basic" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="Basic" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">House Rent</label>
        <input asp-for="HRent" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="HRent" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Medical</label>
        <input asp-for="Medical" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="Medical" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Others</label>
        <input asp-for="Others" class="form-control" type="number" step="0.01" required />
        <span asp-validation-for="Others" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label class="form-label">Join Date</label>
        <input asp-for="dtJoin" class="form-control" type="date" required />
        <span asp-validation-for="dtJoin" class="text-danger"></span>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
</form>

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#employeeEditForm").on("submit", function (e) {
                e.preventDefault();
                if ($(this).valid()) {
                    $.ajax({
                        url: '@Url.Action("Edit", "Employee")',
                        type: "POST",
                        data: $(this).serialize(),
                        success: function (response) {
                            if (response.success) {
                                window.location.href = '@Url.Action("Index", "Employee")';
                            } else {
                                alert("Error occurred");
                            }
                        }
                    });
                }
            });
        });
    </script>
} *@