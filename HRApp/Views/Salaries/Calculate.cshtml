@using HRApp.Models
@{
    var companies = ViewBag.Companies as List<Company>;
}

<div class="container mt-4">
    <h2>Calculate Salary</h2>
    <form id="calculateForm">
        @Html.AntiForgeryToken()
        <div class="form-group mb-3">
            <label for="comId">Company</label>
            <select id="comId" name="comId" class="form-control">
                <option value="">Select Company</option>
                @foreach (var company in companies ?? new List<Company>())
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
            <div id="comId-error" class="text-danger"></div>
        </div>
        <div class="form-group mb-3">
            <label for="dtYear">Year</label>
            <input type="number" id="dtYear" name="dtYear" class="form-control" value="2025" min="2000" max="2100" />
            <div id="dtYear-error" class="text-danger"></div>
        </div>
        <div class="form-group mb-3">
            <label for="dtMonth">Month</label>
            <select id="dtMonth" name="dtMonth" class="form-control">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m" selected="@(m == 9 ? true : false)">@m.ToString("D2")</option>
                }
            </select>
            <div id="dtMonth-error" class="text-danger"></div>
        </div>
        <button type="submit" class="btn btn-primary">Calculate</button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $("#calculateForm").validate({
            rules: {
                comId: { required: true },
                dtYear: { required: true, number: true, min: 2000, max: 2100 },
                dtMonth: { required: true }
            },
            messages: {
                comId: "Please select a company.",
                dtYear: "Please enter a valid year between 2000 and 2100.",
                dtMonth: "Please select a month."
            },
            errorPlacement: function (error, element) {
                error.appendTo("#" + element.attr("name") + "-error");
            }
        });

        $("#calculateForm").submit(function (e) {
            e.preventDefault();
            if ($(this).valid()) {
                $.ajax({
                    url: '/Salaries/Calculate',
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: {
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        alert(response.message);
                        if (response.success) {
                            window.location.href = '/Salaries/SalaryIndex';
                        }
                    },
                    error: function (xhr) {
                        alert("Failed to calculate salary: " + (xhr.responseJSON?.message || "Unknown error"));
                    }
                });
            }
        });
    </script>
}