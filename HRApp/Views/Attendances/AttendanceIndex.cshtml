@model IEnumerable<HRApp.Models.Attendance>
@using HRApp.Models
@{
    ViewData["Title"] = "Attendance List";
    var companies = ViewBag.Companies as List<Company> ?? new List<Company>();
}

<div class="container mt-4">
    <h2>Create Attendance (Single)</h2>

    <form id="createAttendanceForm" method="post">
        @Html.AntiForgeryToken()
        <div class="form-group mb-3">
            <label>Company</label>
            <select id="ComId" name="ComId" class="form-control" required>
                <option value="">-- Select Company --</option>
                @foreach(var company in companies)
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
        </div>
        <div class="form-group mb-3">
            <label>Employee</label>
            <select id="EmpId" name="EmpId" class="form-control" required>
                <option value="">-- Select Employee --</option>
            </select>
        </div>
        <div class="form-group mb-3">
            <label>Date</label>
            <input type="date" name="dtDate" class="form-control" required />
        </div>
        <div class="form-group mb-3">
            <label>In Time</label>
            <input type="time" name="InTime" class="form-control" required />
        </div>
        <div class="form-group mb-3">
            <label>Out Time</label>
            <input type="time" name="OutTime" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary">Create</button>
    </form>

    <h3 class="mt-4">Attendance Records</h3>
    <div class="mb-3">
        <label>Filter by Company</label>
        <select id="companyDropdown" class="form-select w-50">
            <option value="">All Companies</option>
            @foreach(var company in companies)
            {
                <option value="@company.ComId">@company.ComName</option>
            }
        </select>
    </div>
    <table class="table table-bordered" id="attendanceTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Status</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="attendanceTableBody">
            @foreach(var item in Model)
            {
                <tr id="row-@item.Id" data-comid="@item.ComId">
                    <td>@item.dtDate.ToString("yyyy-MM-dd")</td>
                    <td>@(item.Employee != null ? item.Employee.EmpName : "Not Found")</td>
                    <td>@item.AttStatus</td>
                    <td>@item.InTime.ToString("HH:mm")</td>
                    <td>@item.OutTime.ToString("HH:mm")</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal('@item.Id')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('@item.Id')">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="container mt-4">
    <h2>Bulk Attendance (Excel)</h2>
    <div class="mb-3">
        <label>Select Company</label>
        <select id="bulkComId" name="bulkComId" class="form-control" required>
            <option value="">--Select Company--</option>
            @foreach(var company in companies)
            {
                <option value="@company.ComId">@company.ComName</option>
            }
        </select>
    </div>
    <button type="button" id="downloadTemplateBtn" class="btn btn-info mb-2">Download Excel Template</button>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Attendance</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editAttendanceForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="editId" />
                    <div class="form-group mb-3">
                        <label>Company</label>
                        <select id="editComId" name="ComId" class="form-control" required>
                            <option value="">-- Select Company --</option>
                            @foreach(var company in companies)
                            {
                                <option value="@company.ComId">@company.ComName</option>
                            }
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label>Employee</label>
                        <select id="editEmpId" name="EmpId" class="form-control" required>
                            <option value="">-- Select Employee --</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label>Date</label>
                        <input type="date" name="dtDate" id="editDtDate" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label>In Time</label>
                        <input type="time" name="InTime" id="editInTime" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label>Out Time</label>
                        <input type="time" name="OutTime" id="editOutTime" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label>Status</label>
                        <input type="text" id="editAttStatus" class="form-control" readonly />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitEdit()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
    $(document).ready(function() {
        let empToSelect = null;

        // Escape HTML function
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Company filter for attendance records
        $("#companyDropdown").change(function() {
            let comId = $(this).val();
            console.log("Selected comId:", comId);
            $("#attendanceTableBody").empty();
            let url = comId ? '/Attendances/GetAttendancesByCompany?comId=' + comId : '/Attendances/GetAllAttendances';
            console.log("Fetching attendances from:", url);
            $.getJSON(url, function(data) {
                console.log("Filter response:", data);
                if (data.length === 0 || (data.success === false)) {
                    $("#attendanceTableBody").html('<tr><td colspan="6"></td></tr>');
                    return;
                }
                $.each(data, function(i, att) {
                    let row = `
                        <tr id="row-${att.id}" data-comid="${att.comId}">
                            <td>${att.date}</td>
                            <td>${escapeHtml(att.empName)}</td>
                            <td>${att.attStatus}</td>
                            <td>${att.inTime}</td>
                            <td>${att.outTime}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="openEditModal('${att.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${att.id}')">Delete</button>
                            </td>
                        </tr>`;
                    $("#attendanceTableBody").append(row);
                });
            }).fail(function(xhr, status, error) {
                console.error("Filter error:", {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error,
                    url: url
                });
                $("#attendanceTableBody").html('<tr><td colspan="6">Error loading attendance records. Check server status.</td></tr>');
                alert("Failed to filter attendance records: " + (xhr.responseJSON?.message || "Network error or server unavailable."));
            });
        });

        $("#ComId").change(function() {
            var comId = $(this).val();
            $("#EmpId").html('<option value="">-- Select Employee --</option>');
            if (!comId) return;
            $.getJSON('/Attendances/GetEmployeesByCompany?comId=' + comId, function(data) {
                $.each(data, function(i, emp) {
                    $("#EmpId").append(`<option value="${emp.empId}">${emp.empName}</option>`);
                });
            }).fail(function() { alert("Error loading employees."); });
        });

        $("#editComId").change(function() {
            var comId = $(this).val();
            $("#editEmpId").html('<option value="">-- Select Employee --</option>');
            if (!comId) return;
            $.getJSON('/Attendances/GetEmployeesByCompany?comId=' + comId, function(data) {
                $.each(data, function(i, emp) {
                    $("#editEmpId").append(`<option value="${emp.empId}">${emp.empName}</option>`);
                });
                if (empToSelect) {
                    $("#editEmpId").val(empToSelect);
                    empToSelect = null;
                }
            }).fail(function() { alert("Error loading employees."); });
        });

        $("#createAttendanceForm").submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: '/Attendances/AttendanceCreate',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(res) {
                    if (!res.success) {
                        alert(res.message);
                        return;
                    }
                    var att = res.attendance;
                    $("#attendanceTableBody").append(`
                        <tr id="row-${att.id}" data-comid="${att.comId}">
                            <td>${att.date}</td>
                            <td>${escapeHtml(att.empName)}</td>
                            <td>${att.attStatus}</td>
                            <td>${att.inTime}</td>
                            <td>${att.outTime}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" onclick="openEditModal('${att.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${att.id}')">Delete</button>
                            </td>
                        </tr>
                    `);
                    $("#createAttendanceForm")[0].reset();
                    $("#EmpId").html('<option value="">-- Select Employee --</option>');
                    alert(res.message);
                },
                error: function() { alert("Error creating attendance."); }
            });
        });

        window.deleteAttendance = function(id) {
            if (!confirm("Are you sure?")) return;
            $.ajax({
                url: '/Attendances/Delete',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                success: function(res) {
                    if (res.success) {
                        $("#row-" + id).remove();
                        alert(res.message);
                    } else alert(res.message);
                },
                error: function() { alert("Error deleting."); }
            });
        };

        window.openEditModal = function(id) {
            $.getJSON('/Attendances/GetAttendance?id=' + id, function(data) {
                $('#editId').val(data.id);
                empToSelect = data.empId;
                $('#editComId').val(data.comId).trigger('change');
                $('#editDtDate').val(data.dtDate);
                $('#editInTime').val(data.inTime);
                $('#editOutTime').val(data.outTime);
                $('#editAttStatus').val(data.attStatus);
                $('#editModal').modal('show');
            }).fail(function() { alert("Error loading data."); });
        };

        window.submitEdit = function() {
            var formData = new FormData($('#editAttendanceForm')[0]);
            var id = $('#editId').val();
            $.ajax({
                url: '/Attendances/AttendanceEdit?id=' + id,
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(res) {
                    if (!res.success) {
                        alert(res.message);
                        return;
                    }
                    var att = res.attendance;
                    var row = $('#row-' + att.id);
                    row.find('td:nth-child(1)').text(att.date);
                    row.find('td:nth-child(2)').text(escapeHtml(att.empName));
                    row.find('td:nth-child(3)').text(att.attStatus);
                    row.find('td:nth-child(4)').text(att.inTime);
                    row.find('td:nth-child(5)').text(att.outTime);
                    row.attr('data-comid', att.comId);
                    $('#editModal').modal('hide');
                    alert(res.message);
                },
                error: function() { alert("Error updating."); }
            });
        };

        $("#downloadTemplateBtn").click(function() {
            var comId = $("#bulkComId").val();
            if (!comId) {
                alert("Select company first.");
                return;
            }
            window.location.href = `/Attendances/DownloadAttendanceTemplate?comId=${comId}`;
        });
    });
    </script>
}