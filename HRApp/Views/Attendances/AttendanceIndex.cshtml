@model IEnumerable<HRApp.Models.Attendance>
@using HRApp.Models
@{
    ViewData["Title"] = "Attendance List";
    var companies = ViewBag.Companies as List<Company> ?? new List<Company>();
    var employees = ViewBag.Employees as List<Employee> ?? new List<Employee>();
}
<div class="container mt-4">
    <h2>Create Attendance (Single)</h2>

    <form id="createAttendanceForm">
        @Html.AntiForgeryToken()

        <div class="form-group mb-3">
            <label for="ComId">Company</label>
            <select id="ComId" name="ComId" class="form-control" required>
                <option value="">-- Select Company --</option>
                @foreach (var company in companies)
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
        </div>

        <div class="form-group mb-3">
            <label for="EmpId">Employee</label>
            <select id="EmpId" name="EmpId" class="form-control" required>
                <option value="">-- Select Employee --</option>
                <!-- JS দিয়ে এখানে populate হবে -->
            </select>
        </div>

        <div class="form-group mb-3">
            <label for="dtDate">Date</label>
            <input type="date" id="dtDate" name="dtDate" class="form-control" required />
        </div>

        <div class="form-group mb-3">
            <label for="InTime">In Time</label>
            <input type="time" id="InTime" name="InTime" class="form-control" required />
        </div>

        <div class="form-group mb-3">
            <label for="OutTime">Out Time</label>
            <input type="time" id="OutTime" name="OutTime" class="form-control" required />
        </div>

        <div class="form-group mb-3">
            <label for="AttStatus">Status</label>
            <select id="AttStatus" name="AttStatus" class="form-control" required>
                <option value="P">Present</option>
                <option value="L">Late</option>
                <option value="A">Absent</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Create</button>
    </form>
</div>
    <div class="container mt-4">
        <h2>Bulk Attendance (Excel)</h2>

        <!-- Company select -->
        <div class="mb-3">
            <label>Select Company</label>
            <select id="bulkComId" class="form-control">
                <option value="">--Select Company--</option>
                @foreach (var company in companies)
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
        </div>
        <!-- Download Template -->
        <button type="button" id="downloadTemplateBtn" class="btn btn-info mb-3">Download Excel Template</button>
        <!-- Excel Upload Form -->
        <form id="uploadExcelForm" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <div class="mb-3">
                <input type="file" name="file" class="form-control" accept=".xlsx" required />
            </div>
            <button type="submit" class="btn btn-success">Upload & Save</button>
        </form>

        <div id="uploadResult" class="mt-3"></div>
    </div>


    <!-- Attendance List Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Status</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="attendanceTable">
            @foreach (var item in Model)
            {
                <tr id="row-@item.Id">
                    <td>@item.dtDate.ToString("yyyy-MM-dd")</td>
                    <td>@item.Employee?.EmpName ?? "N/A"</td>
                    <td>@item.AttStatus</td>
                    <td>@item.InTime.ToString("HH:mm")</td>
                    <td>@item.OutTime.ToString("HH:mm")</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal('@item.Id')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('@item.Id')">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
              $(document).ready(function () {

            // 🔹 Filter employees by company
            $("#ComId").change(function () {
                var comId = $(this).val();
                var employeeDropdown = $("#EmpId");
                employeeDropdown.empty();
                employeeDropdown.append('<option value="">-- Select Employee --</option>');

                if (!comId) return; // কোন company select না করলে

                $.getJSON('/Attendances/GetEmployeesByCompany', { comId: comId }, function (data) {
                    if (data.length === 0) {
                        employeeDropdown.append('<option value="">No employees found</option>');
                        return;
                    }
                    $.each(data, function (i, employee) {
                        employeeDropdown.append('<option value="' + employee.empId + '">' + employee.empName + '</option>');
                    });
                });
            });

            // 🔹 Submit single attendance
            $("#createAttendanceForm").submit(function (e) {
                e.preventDefault();
                var formData = $(this).serialize();

                $.post('/Attendances/AttendanceCreate', formData, function (response) {
                    alert(response.message || "Attendance created successfully.");
                    if (response.success) {
                        var att = response.attendance;

                        // নতুন row append
                        $("#attendanceTable").append(`
                            <tr id="row-${att.id}">
                                <td>${att.date}</td>
                                <td>${att.empName}</td>
                                <td>${att.attStatus}</td>
                                <td>${att.inTime}</td>
                                <td>${att.outTime}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm" onclick="openEditModal('${att.id}')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${att.id}')">Delete</button>
                                </td>
                            </tr>
                        `);

                        // ফর্ম reset
                        $("#createAttendanceForm")[0].reset();
                        $("#EmpId").empty().append('<option value="">-- Select Employee --</option>'); // Employee dropdown reset
                    }
                });
            });

        });

            // Load employees for bulk attendance
                $("#bulkComId").change(function(){
            var comId = $(this).val();
            var tbody = $("#bulkEmployeeTable tbody");
            tbody.empty();
            if(!comId) return;

            $.getJSON(`/Attendances/GetEmployeesByCompany?comId=${comId}`, function(employees){
                if(!employees.length) {
                    tbody.append('<tr><td colspan="5">No employees found.</td></tr>');
                    return;
                }
                employees.forEach(emp => {
                    tbody.append(`
                        <tr>
                            <td><input type="checkbox" name="EmpIds" value="${emp.empId}"></td>
                            <td>${emp.empName}</td>
                            <td><input type="time" name="InTimes" class="form-control" value="09:00"></td>
                            <td><input type="time" name="OutTimes" class="form-control" value="17:00"></td>
                            <td>
                                <select name="AttStatuses" class="form-control">
                                    <option value="P">Present</option>
                                    <option value="L">Late</option>
                                    <option value="A">Absent</option>
                                </select>
                            </td>
                        </tr>
                    `);
                });
            });
        });

                // Download Excel Template
        $("#downloadTemplateBtn").click(function () {
            var comId = $("#bulkComId").val();
            if (!comId) {
                alert("Please select a company first.");
                return;
            }
            window.location.href = `/Attendances/DownloadAttendanceTemplate?comId=${comId}`;
        });

    </script>
}
