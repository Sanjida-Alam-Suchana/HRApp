@model IEnumerable<HRApp.Models.Attendance>
@using HRApp.Models
@{
    ViewData["Title"] = "Attendance List";
    var companies = ViewBag.Companies as List<Company> ?? new List<Company>();
    var employees = ViewBag.Employees as List<Employee> ?? new List<Employee>();
}

<div class="container mt-4">
    <h2>Attendance List</h2>

    <!-- Single Attendance Form -->
    <div class="card mb-4 p-3">
        <h4>Create New Attendance (Single)</h4>
        <form id="createAttendanceForm">
            @Html.AntiForgeryToken()
            <div class="form-group mb-3">
                <label for="ComId">Company</label>
                <select id="ComId" name="ComId" class="form-control" required>
                    <option value="">Select Company</option>
                    @foreach (var company in companies)
                    {
                        <option value="@company.ComId">@company.ComName</option>
                    }
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="EmpId">Employee</label>
                <select id="EmpId" name="EmpId" class="form-control" required>
                    <option value="">Select Employee</option>
                    @foreach (var employee in employees)
                    {
                        <option value="@employee.EmpId" data-comid="@employee.ComId.ToString()" data-shift-starttime="@(employee.Shift?.StartTime.ToString("HH:mm") ?? "")">@employee.EmpName</option>
                    }
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="dtDate">Date</label>
                <input type="date" id="dtDate" name="dtDate" class="form-control" required />
            </div>
            <div class="form-group mb-3">
                <label for="InTime">In Time</label>
                <input type="time" id="InTime" name="InTime" class="form-control" required />
            </div>
            <div class="form-group mb-3">
                <label for="OutTime">Out Time</label>
                <input type="time" id="OutTime" name="OutTime" class="form-control" required />
            </div>
            <div class="form-group mb-3">
                <label for="AttStatus">Status</label>
                <select id="AttStatus" name="AttStatus" class="form-control" required>
                    <option value="P">Present</option>
                    <option value="L">Late</option>
                    <option value="A">Absent</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Create</button>
        </form>
    </div>

    <!-- Bulk Attendance Form -->
    <div class="card mb-4 p-3">
        <h4>Bulk Attendance Entry</h4>
        <form id="bulkAttendanceForm">
            @Html.AntiForgeryToken()
            <div class="form-group mb-3">
                <label for="bulkComId">Company</label>
                <select id="bulkComId" name="ComId" class="form-control" required>
                    <option value="">Select Company</option>
                    @foreach (var company in companies)
                    {
                        <option value="@company.ComId">@company.ComName</option>
                    }
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="bulkDtDate">Date</label>
                <input type="date" id="bulkDtDate" name="dtDate" class="form-control" required />
            </div>

            <table class="table table-bordered" id="bulkEmployeeTable">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Employee</th>
                        <th>In Time</th>
                        <th>Out Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var employee in employees)
                    {
                        <tr data-comid="@employee.ComId">
                            <td><input type="checkbox" name="EmpIds" value="@employee.EmpId" /></td>
                            <td>@employee.EmpName</td>
                            <td><input type="time" name="InTimes" class="form-control" /></td>
                            <td><input type="time" name="OutTimes" class="form-control" /></td>
                            <td>
                                <select name="AttStatuses" class="form-control">
                                    <option value="P">Present</option>
                                    <option value="L">Late</option>
                                    <option value="A">Absent</option>
                                </select>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <button type="submit" class="btn btn-success">Save Bulk Attendance</button>
        </form>
    </div>

    <!-- Company Dropdown Filter -->
    <select id="companyDropdown" class="form-select mb-3" onchange="setCompany(this.value)">
        <option value="">Select Company</option>
        @foreach (var company in companies)
        {
            <option value="@company.ComId.ToString()">@company.ComName</option>
        }
    </select>

    <!-- Hidden AntiForgery token -->
    <form id="antiForgeryForm">
        @Html.AntiForgeryToken()
    </form>

    <!-- Edit Modal -->
    <div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-labelledby="editAttendanceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAttendanceModalLabel">Edit Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAttendanceForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="editId" name="Id" />
                        <div class="form-group mb-3">
                            <label for="editComId">Company</label>
                            <select id="editComId" name="ComId" class="form-control" required>
                                <option value="">Select Company</option>
                                @foreach (var company in companies)
                                {
                                    <option value="@company.ComId">@company.ComName</option>
                                }
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="editEmpId">Employee</label>
                            <select id="editEmpId" name="EmpId" class="form-control" required>
                                <option value="">Select Employee</option>
                                @foreach (var employee in employees)
                                {
                                    <option value="@employee.EmpId" data-comid="@employee.ComId.ToString()" data-shift-starttime="@(employee.Shift?.StartTime.ToString("HH:mm") ?? "")">@employee.EmpName</option>
                                }
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label for="editDtDate">Date</label>
                            <input type="date" id="editDtDate" name="dtDate" class="form-control" required />
                        </div>
                        <div class="form-group mb-3">
                            <label for="editInTime">In Time</label>
                            <input type="time" id="editInTime" name="InTime" class="form-control" required />
                        </div>
                        <div class="form-group mb-3">
                            <label for="editOutTime">Out Time</label>
                            <input type="time" id="editOutTime" name="OutTime" class="form-control" required />
                        </div>
                        <div class="form-group mb-3">
                            <label for="editAttStatus">Status</label>
                            <select id="editAttStatus" name="AttStatus" class="form-control" required>
                                <option value="P">Present</option>
                                <option value="L">Late</option>
                                <option value="A">Absent</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance List Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Status</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="attendanceTable">
            @foreach (var item in Model)
            {
                var employeeName = item.Employee?.EmpName ?? "N/A";
                <tr id="row-@item.Id" data-comid="@item.ComId.ToString()" data-empid="@item.EmpId" data-dtdate="@item.dtDate.ToString("yyyy-MM-dd")" data-intime="@item.InTime.ToString("HH:mm")" data-outtime="@item.OutTime.ToString("HH:mm")" data-attstatus="@item.AttStatus">
                    <td>@item.dtDate.ToString("yyyy-MM-dd")</td>
                    <td>@employeeName</td>
                    <td>@item.AttStatus</td>
                    <td>@item.InTime.ToString("HH:mm")</td>
                    <td>@item.OutTime.ToString("HH:mm")</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal('@item.Id')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('@item.Id')">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
          // === Single Attendance Employee Filter ===
$("#ComId").change(function () {
    var comId = $(this).val();
    $("#EmpId option").each(function () {
        var empComId = $(this).data("comid");
        if (comId === "" || empComId == comId) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
    $("#EmpId").val(""); // Reset employee selection
});

// === Edit Modal Employee Filter ===
$("#editComId").change(function () {
    var comId = $(this).val();
    $("#editEmpId option").each(function () {
        var empComId = $(this).data("comid");
        if (comId === "" || empComId == comId) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
    $("#editEmpId").val(""); // Reset employee selection
});
$("#bulkEmployeeTable tbody tr").hide(); // hide all initially

$("#bulkComId").change(function () {
    var comId = $(this).val();
    $("#bulkEmployeeTable tbody tr").each(function () {
        var empComId = $(this).data("comid");
        $(this).toggle(comId === "" || empComId === comId);
    });
});

   $("#bulkAttendanceForm").submit(function (e) {
                e.preventDefault();  // Prevent normal form submission
                var selectedEmployees = [];
                $("#bulkEmployeeTable tbody tr").each(function () {
                    var checkbox = $(this).find("input[type=checkbox]");
                    if (checkbox.is(":checked")) {
                        selectedEmployees.push({
                            EmpId: checkbox.val(),
                            InTime: $(this).find("input[name='InTimes']").val(),
                            OutTime: $(this).find("input[name='OutTimes']").val(),
                            AttStatus: $(this).find("select[name='AttStatuses']").val(),
                            dtDate: $("#bulkDtDate").val(),
                            ComId: $("#bulkComId").val()
                        });
                    }
                });

    if (selectedEmployees.length === 0) { alert("Please select at least one employee."); return; }

    $.ajax({
        url: '/Attendances/BulkCreate', // your existing bulk save action
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(selectedEmployees),
        headers: { "RequestVerificationToken": $('#antiForgeryForm input[name="__RequestVerificationToken"]').val() },
        success: function (response) {
            alert(response.message);

            if(response.success) {
                // Trigger download after saving
                var comId = $("#bulkComId").val();
                var dtDate = $("#bulkDtDate").val();
                window.location.href = `/Attendances/DownloadBulkAttendance?comId=${comId}&dtDate=${dtDate}`;
            }
        },
        error: function () { alert("Bulk attendance failed."); }
    });
});


        function setCompany(comId) {
            $("#attendanceTable tr").each(function () {
                var rowComId = $(this).data("comid");
                $(this).toggle(comId === "" || rowComId === comId);
            });
        }
    </script>
}
