@model dynamic
@{
    ViewData["Title"] = "Attendance List — filter by Department";
    var companies = ViewBag.Companies as IEnumerable<HRApp.Models.Company>;
    var selectedComId = ViewBag.SelectedComId as string;
}

<h2>Attendance List — filter by Department</h2>

<div class="form-group">
    <label>Company</label>
    <select id="companySelect" class="form-control">
        <option value="">-- Select company --</option>
        @foreach (var company in companies ?? Enumerable.Empty<HRApp.Models.Company>())
        {
            var isSelected = company.ComId.ToString() == selectedComId;
            <option value="@company.ComId" selected="@(isSelected ? "selected" : null)">
                @company.ComName
            </option>
        }
    </select>
</div>

<div class="form-group">
    <label>Department</label>
    <select id="departmentSelect" class="form-control">
        <option value="">-- All departments --</option>
    </select>
</div>

<div class="form-group">
    <label>From Date</label>
    <input type="date" id="fromDate" class="form-control">
</div>

<div class="form-group">
    <label>To Date</label>
    <input type="date" id="toDate" class="form-control">
</div>

<button id="loadBtn" class="btn btn-primary">Load</button>
<button id="resetBtn" class="btn btn-secondary">Reset</button>
<button id="printBtn" class="btn btn-warning">Print</button>
<button id="pdfBtn" class="btn btn-danger">Download PDF</button>
<button id="csvBtn" class="btn btn-success">CSV</button>
<button id="excelBtn" class="btn btn-info">Excel</button>

<table id="attendanceTable" class="table table-striped mt-3" style="display:none;">
    <thead>
        <tr>
            <th>Employee Name</th>
            <th>Total Present</th>
            <th>Total Absent</th>
            <th>Total Late</th>
            <th>Total Absent</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
<script>
    $(document).ready(function () {
        var initialCompanyId = $('#companySelect').val();
        if (initialCompanyId) {
            loadDepartments(initialCompanyId);
        }

        $('#companySelect').change(function () {
            var companyId = $(this).val();
            document.cookie = "SelectedComId=" + companyId + "; path=/";
            loadDepartments(companyId);
        });

        function loadDepartments(companyId) {
            if (companyId) {
                $.ajax({
                   url: '/Reports/GetDepartmentsByCompany',
                    type: 'GET',
                    data: { companyId: companyId },
                    success: function (data) {
                        $('#departmentSelect').html('<option value="">-- All departments --</option>');
                        $.each(data, function (i, dept) {
                            $('#departmentSelect').append(
                                '<option value="' + dept.id + '">' + dept.name + '</option>'
                            );
                        });
                    }
                });
            } else {
                $('#departmentSelect').html('<option value="">-- All departments --</option>');
            }
        }

        $('#loadBtn').click(function () {
            var companyId = $('#companySelect').val();
            var departmentId = $('#departmentSelect').val();
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!companyId) { 
                alert('Select a company'); 
                return; 
            }
            
            if (!fromDate || !toDate) { 
                alert('Select date range'); 
                return; 
            }
            
            if (new Date(fromDate) > new Date(toDate)) { 
                alert('From date cannot be greater than to date'); 
                return; 
            }
            
            $.ajax({
                url: '/Reports/GetAttendanceList',
                type: 'POST',
                data: { 
                    companyId: companyId, 
                    departmentId: departmentId || '', 
                    fromDate: fromDate,
                    toDate: toDate
                },
                success: function (response) {
                    if (response.success) {
                        $('#attendanceTable tbody').empty();
                        $.each(response.data, function (i, att) {
                            $('#attendanceTable tbody').append(
                                '<tr>' +
                                '<td>' + att.employeeName + '</td>' +
                                '<td class="text-center"><span class="badge bg-success">' + att.totalPresent + '</span></td>' +
                                '<td class="text-center"><span class="badge bg-danger">' + att.totalAbsent + '</span></td>' +
                                '<td class="text-center"><span class="badge bg-warning">' + att.totalLate + '</span></td>' +
                                '<td class="text-center"><span class="badge bg-danger">' + att.totalAbsentAgain + '</span></td>' +
                                '</tr>'
                            );
                        });
                        $('#attendanceTable').show();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function () {
                    alert('Error loading attendance data');
                }
            });
        });

        $('#resetBtn').click(function () {
            $('#companySelect').val('');
            $('#departmentSelect').html('<option value="">-- All departments --</option>');
            $('#fromDate').val('');
            $('#toDate').val('');
            $('#attendanceTable').hide();
        });

        $('#printBtn').click(function () { 
            if ($('#attendanceTable').is(':visible')) {
                window.print(); 
            } else {
                alert('Please load data first');
            }
        });

        $('#pdfBtn').click(function () {
            var companyId = $('#companySelect').val();
            var departmentId = $('#departmentSelect').val() || '';
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!companyId || !fromDate || !toDate) { 
                alert('Select company and date range'); 
                return; 
            }
            window.location = '/Reports/DownloadAttendanceListPdf?companyId=' + companyId + 
                            '&departmentId=' + departmentId + 
                            '&fromDate=' + fromDate + 
                            '&toDate=' + toDate;
        });

        $('#csvBtn').click(function () {
            var companyId = $('#companySelect').val();
            var departmentId = $('#departmentSelect').val() || '';
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!companyId || !fromDate || !toDate) { 
                alert('Select company and date range'); 
                return; 
            }
            window.location = '/Reports/DownloadAttendanceListCsv?companyId=' + companyId + 
                            '&departmentId=' + departmentId + 
                            '&fromDate=' + fromDate + 
                            '&toDate=' + toDate;
        });

        $('#excelBtn').click(function () {
            var companyId = $('#companySelect').val();
            var departmentId = $('#departmentSelect').val() || '';
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (!companyId || !fromDate || !toDate) { 
                alert('Select company and date range'); 
                return; 
            }
            window.location = '/Reports/DownloadAttendanceListExcel?companyId=' + companyId + 
                            '&departmentId=' + departmentId + 
                            '&fromDate=' + fromDate + 
                            '&toDate=' + toDate;
        });

        // Set default date range (last 30 days)
        var today = new Date();
        var thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        $('#fromDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
        $('#toDate').val(today.toISOString().split('T')[0]);

        // Auto-load if all fields are filled
        function checkAutoLoad() {
            var companyId = $('#companySelect').val();
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            
            if (companyId && fromDate && toDate) {
                $('#loadBtn').trigger('click');
            }
        }

        $('#companySelect, #fromDate, #toDate').change(checkAutoLoad);
    });
</script>
}