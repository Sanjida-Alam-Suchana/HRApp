<!-- AttendanceSummaryGenerate.cshtml (Updated to use type="month", AJAX sends SummaryMonth as yyyy-MM, updated validation) -->
@model HRApp.Models.AttendanceSummary
@using HRApp.Models
@{
    ViewData["Title"] = "Generate Attendance Summary";
    var companies = ViewBag.Companies as List<Company>;
}

<div class="container mt-4">
    <h2>Generate Attendance Summary</h2>
    <form id="generateForm">
        @Html.AntiForgeryToken()
        <div class="form-group mb-3">
            <label for="ComId">Company</label>
            <select id="ComId" name="ComId" class="form-control">
                <option value="">Select Company</option>
                @foreach (var company in companies ?? new List<Company>())
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
            <div id="ComId-error" class="text-danger"></div>
        </div>
        <div class="form-group mb-3">
            <label for="SummaryMonth">Month</label>
            <input type="month" class="form-control" id="SummaryMonth" name="SummaryMonth" value="@DateTime.Now.ToString("yyyy-MM")" />
            <div id="SummaryMonth-error" class="text-danger"></div>
        </div>
        <button type="submit" class="btn btn-primary">Generate Summary</button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $("#generateForm").validate({
            rules: {
                ComId: { required: true },
                SummaryMonth: { required: true }
            },
            messages: {
                ComId: "Please select a company.",
                SummaryMonth: "Please select a month."
            },
            errorPlacement: function (error, element) {
                error.appendTo("#" + element.attr("name") + "-error");
            }
        });

        $("#generateForm").submit(function (e) {
            e.preventDefault();
            if ($(this).valid()) {
                var comId = $("#ComId").val();
                var summaryMonth = $("#SummaryMonth").val();

                $.ajax({
                    url: '/AttendanceSummaries/AttendanceSummaryGenerate',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        ComId: comId,
                        SummaryMonth: summaryMonth
                    },
                    success: function (response) {
                        alert(response.message);
                        if (response.success) {
                            window.location.href = '/AttendanceSummaries/AttendanceSummaryIndex';
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("AJAX Error:", {
                            status: status,
                            error: error,
                            responseText: xhr.responseText,
                            responseJSON: xhr.responseJSON
                        });
                        alert("Failed to generate summary: " + (xhr.responseJSON?.message || "Unknown error"));
                    }
                });
            }
        });
    </script>
}