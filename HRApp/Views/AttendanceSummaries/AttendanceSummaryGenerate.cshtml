@model HRApp.Models.AttendanceSummary
@using HRApp.Models
@{
    ViewData["Title"] = "Generate Attendance Summary";
    var companies = ViewBag.Companies as List<Company>;
}

<div class="container mt-4">
    <h2>Generate Attendance Summary</h2>
    <form id="generateForm">
        @Html.AntiForgeryToken()
        <div class="form-group mb-3">
            <label for="ComId">Company</label>
            <select id="ComId" name="ComId" class="form-control">
                <option value="">Select Company</option>
                @foreach (var company in companies ?? new List<Company>())
                {
                    <option value="@company.ComId">@company.ComName</option>
                }
            </select>
            <div id="ComId-error" class="text-danger"></div>
        </div>
        <div class="form-group mb-3">
            <label for="SummaryYear">Year</label>
            <input type="number" class="form-control" id="SummaryYear" name="SummaryYear" value="@DateTime.Now.Year" min="2000" max="2100" />
            <div id="SummaryYear-error" class="text-danger"></div>
        </div>
        <div class="form-group mb-3">
            <label for="SummaryMonth">Month</label>
            <select id="SummaryMonth" name="SummaryMonth" class="form-control">
                @for (int m = 1; m <= 12; m++)
                {
                    <option value="@m" selected="@(m == DateTime.Now.Month ? true : false)">@m.ToString("D2")</option>
                }
            </select>
            <div id="SummaryMonth-error" class="text-danger"></div>
        </div>
        <button type="submit" class="btn btn-primary">Generate Summary</button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>

    <script>
        $("#generateForm").validate({
            rules: {
                ComId: { required: true },
                SummaryYear: { required: true, number: true, min: 2000, max: 2100 },
                SummaryMonth: { required: true }
            },
            messages: {
                ComId: "Please select a company.",
                SummaryYear: "Please enter a valid year between 2000 and 2100.",
                SummaryMonth: "Please select a month."
            },
            errorPlacement: function (error, element) {
                error.appendTo("#" + element.attr("name") + "-error");
            }
        });

        $("#generateForm").submit(function (e) {
            e.preventDefault();
            if ($(this).valid()) {
                var comId = $("#ComId").val();
                var year = $("#SummaryYear").val();
                var month = $("#SummaryMonth").val();
                
                $.ajax({
                    url: '/AttendanceSummaries/AttendanceSummaryGenerate',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        ComId: comId,
                        SummaryMonth: year + '-' + month + '-01'
                    },
                    success: function (response) {
                        alert(response.message);
                        if (response.success) {
                            window.location.href = '/AttendanceSummaries/AttendanceSummaryIndex';
                        }
                    },
                    error: function (xhr) {
                        alert("Failed to generate summary: " + (xhr.responseJSON?.message || "Unknown error"));
                    }
                });
            }
        });
    </script>
}